"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6207],{6207:(re,S,s)=>{s.r(S),s.d(S,{JmjCompraHistPageModule:()=>Q});var u=s(177),O=s(9417),c=s(7343),f=s(1050),l=s(467),g=s(7586),P=s(8448),R=s(8765),x=s(1432),T=s(5312),A=s(7469),o=s(4438),N=s(2767),F=s(3943),z=s(6356),j=s(4615),_=s(2130),I=s(9777),J=s(5032),M=s(3239),b=s(2464),E=s(1527),D=s(5161),k=s(385);const y=a=>[a];function B(a,d){if(1&a){const t=o.RV6();o.j41(0,"ion-button",9),o.bIt("click",function(){o.eBV(t);const r=o.XpG();return o.Njj(r.abrirParametros())}),o.nrm(1,"ion-icon",10),o.k0s()}}function U(a,d){if(1&a&&(o.j41(0,"ion-col",31),o.EFF(1),o.nI1(2,"number"),o.k0s()),2&a){const t=o.XpG().$implicit;o.R7$(),o.JRh(o.i5U(2,1,t.importe,"1.0-0"))}}function Y(a,d){if(1&a&&(o.j41(0,"ion-col",31),o.EFF(1),o.nI1(2,"number"),o.k0s()),2&a){const t=o.XpG().$implicit;o.R7$(),o.JRh(o.i5U(2,1,t.saldo,"1.0-0"))}}function G(a,d){if(1&a){const t=o.RV6();o.j41(0,"ion-row",22),o.bIt("click",function(){const r=o.eBV(t).$implicit,i=o.XpG(2);return o.Njj(i.Acciones(r))}),o.j41(1,"ion-col",23),o.EFF(2),o.k0s(),o.j41(3,"ion-col",24),o.EFF(4),o.k0s(),o.j41(5,"ion-col",25),o.EFF(6),o.k0s(),o.j41(7,"ion-col",26),o.EFF(8),o.k0s(),o.j41(9,"ion-col",27),o.EFF(10),o.k0s(),o.DNE(11,U,3,4,"ion-col",28)(12,Y,3,4,"ion-col",28),o.j41(13,"ion-col",29),o.EFF(14),o.nI1(15,"number"),o.k0s(),o.j41(16,"ion-col",30),o.EFF(17),o.k0s()()}if(2&a){const t=d.$implicit,e=o.XpG(2);o.Y8G("ngClass",o.eq3(13,y,t.estado)),o.R7$(2),o.JRh(t.tipoFactura),o.R7$(2),o.JRh(t.fechaHoraFactura),o.R7$(2),o.JRh(t.nroRecibo),o.R7$(2),o.JRh(t.docNum),o.R7$(2),o.JRh(t.codigoProveedor),o.R7$(),o.Y8G("ngIf","COBROS"!==e.tipoTran),o.R7$(),o.Y8G("ngIf","COBROS"===e.tipoTran),o.R7$(2),o.JRh(o.i5U(15,10,t.importePago,"1.0-0")),o.R7$(3),o.JRh(t.estado)}}function H(a,d){if(1&a&&(o.j41(0,"div")(1,"ion-col",32)(2,"ion-item",33)(3,"ion-label",34),o.EFF(4,"COMPRADO : "),o.k0s(),o.j41(5,"p",35),o.EFF(6),o.nI1(7,"number"),o.k0s()(),o.j41(8,"ion-item",33)(9,"ion-label",34),o.EFF(10,"PAGADO : "),o.k0s(),o.j41(11,"p",35),o.EFF(12),o.nI1(13,"number"),o.k0s()(),o.j41(14,"ion-item",33)(15,"ion-label",34),o.EFF(16,"A PAGAR : "),o.k0s(),o.j41(17,"p",35),o.EFF(18),o.nI1(19,"number"),o.k0s()()()()),2&a){const t=o.XpG(2);o.R7$(6),o.JRh(o.i5U(7,3,t.totalComprado,"1.0-0")),o.R7$(6),o.JRh(o.i5U(13,6,t.totalPagadoNeto,"1.0-0")),o.R7$(6),o.JRh(o.i5U(19,9,t.totalApagar,"1.0-0"))}}function L(a,d){if(1&a&&(o.j41(0,"div")(1,"ion-col",32)(2,"ion-item",33)(3,"ion-label",34),o.EFF(4,"COBRADO : "),o.k0s(),o.j41(5,"p",35),o.EFF(6),o.nI1(7,"number"),o.k0s()()()()),2&a){const t=o.XpG(2);o.R7$(6),o.JRh(o.i5U(7,1,t.totalPagadoNeto,"1.0-0"))}}function $(a,d){if(1&a&&(o.j41(0,"ion-grid")(1,"ion-row",11)(2,"ion-col",12)(3,"ion-list")(4,"ion-grid")(5,"ion-row")(6,"ion-col",13),o.EFF(7,"Tip"),o.k0s(),o.j41(8,"ion-col",14),o.EFF(9,"Fecha"),o.k0s(),o.j41(10,"ion-col",15),o.EFF(11,"Rec"),o.k0s(),o.j41(12,"ion-col",16),o.EFF(13,"Nro"),o.k0s(),o.j41(14,"ion-col",17),o.EFF(15,"Prov"),o.k0s(),o.j41(16,"ion-col",18),o.EFF(17),o.k0s(),o.j41(18,"ion-col",19),o.EFF(19),o.k0s(),o.j41(20,"ion-col",20),o.EFF(21,"Est."),o.k0s()(),o.DNE(22,G,18,15,"ion-row",21),o.j41(23,"ion-row",11),o.DNE(24,H,20,12,"div",8)(25,L,8,4,"div",8),o.k0s()()()()()()),2&a){const t=o.XpG();o.R7$(17),o.JRh(t.tituloMto),o.R7$(2),o.JRh(t.tituloPag),o.R7$(3),o.Y8G("ngForOf",t.compras),o.R7$(2),o.Y8G("ngIf","COMPRAS"===t.tipoTran),o.R7$(),o.Y8G("ngIf","COBROS"===t.tipoTran)}}const V=[{path:":tipoTran",component:(()=>{class a{constructor(t,e,r,i,n,m,p,v,h,C,W,K,Z,q,ee,oe,te){this.jmjModoConexionService=t,this.jmjStorageService=e,this.route=r,this.jmjNroALetraService=i,this.ticketPrestamoService=n,this.apiSvc=m,this.printSvc=p,this.actionCtrl=v,this.modalCtrl=h,this.alertCtrl=C,this.ticketService=W,this.navCtrl=K,this.authSvc=Z,this.toastController=q,this.popoverCtrl=ee,this.alertSvc=oe,this.loaderSvc=te,this.tipoFactura=null,this.compras=[],this.ticket=new P.L(0,2),this.ticketPrestamo=new P.L(0,2),this.bluetoothList=[],this.selectedPrinter=null,this.comprasRealizadas={},this.comprasPagadas={},this.comprasApagar={},this.totalComprado=0,this.totalPagado=0,this.totalPagadoNeto=0,this.totalApagar=0,this.index_prestamo=-1,this.parametro="HOY",this.modoOffLine=!1,this.fecIni=g().format("DD/MM/YYYY"),this.fecFin=g().format("DD/MM/YYYY"),this.parametros=g().format("DD/MM/YYYY"),this.BTN_OPTION_MORE_ACTIVE=[{}],this.BTN_OPTION_MORE=[{}],this.tipoTran=this.route.snapshot.paramMap.get("tipoTran"),"COMPRAS"===this.tipoTran?(this.titulo="Compras Realizadas",this.tituloMto="Importe",this.tituloPag="Imp.Pago"):(this.titulo="Cobros Pr\xe9stamos Realizados",this.tituloMto="Saldo Pr.",this.tituloPag="Imp.Cobro")}ngOnInit(){this.getPrinters(),this.recuperarDatos()}doRefresh(t){var e=this;return(0,l.A)(function*(){e.jmjModoConexionService.getModoOffLine()?t.target.complete():(yield e.recuperarDatos(),t.target.complete(),setTimeout(()=>{t.target.complete()},2e3))})()}recuperarDatos(){var t=this;return(0,l.A)(function*(){if(t.fecIni=t.fecIni.replace(/\//g,"").toString(),t.fecFin=t.fecFin.replace(/\//g,"").toString(),t.iJmjTiposPago=JSON.parse(yield t.jmjStorageService.getData(t.jmjStorageService.TIPOS_PAGOS)),t.jmjModoConexionService.getModoOffLine()){if(t.modoOffLine=!0,t.iJmjCompra=null,t.iJmjCompras=[],t.compras=[],t.transacciones={},"COMPRAS"===t.tipoTran){if(t.transacciones=JSON.parse(yield t.jmjStorageService.getData(t.jmjStorageService.COMPRAS)),!t.transacciones)return void t.alertSvc.info("No existen datos");for(const e of t.transacciones){const r=Object.assign({},{codigoProveedor:e.codigoProveedor,codigoTransaccion:e.codigoTransaccion,docNum:null,usuario:e.usuario,estado:e.estado,facturaDetalle:e.facturaDetalle.map(i=>({cantidad:i.cantidad,codigoArticulo:i.codigoArticulo,facturacion:i.facturacion,lote:i.lote,nombreArticulo:i.descripcionArticulo?i.descripcionArticulo:i.nombreArticulo,pesoBruto:i.pesoBruto,precioUnitario:i.precioUnitario,tara:i.tara,total:Number(Number(Number(i.precioUnitario).toFixed(0))*Number(i.cantidad)).toFixed(0),vencimientoLote:i.vencimientoLote,densidad:i.densidad?parseFloat(i.densidad.toString().replace(/\,/g,".")):0,fucsina:i.fucsina||0,solubilidad:i.solubilidad||0,envaseComprador:i.envaseComprador})),facturacion:e.facturacion,fechaHoraFactura:e.fechaHoraFactura,identificador:e.codigoTransaccion,importe:0,precioUnitario:0,nroRecibo:e.nroRecibo,proveedor:e.nombreProveedor?e.nombreProveedor:e.codigoProveedor,tipoComprobante:e.tipoComprobante,tipoFactura:e.tipoFactura,valores:e.valores?e.valores.map(i=>({docNum:i.nroDocumento,fechaHoraPago:i.fecha,monto:i.monto,tipoPago:i.tipoPago,nrocuenta:i.nrocuenta})):null});t.compras.push(r)}}t.congigurarDatos(t.compras)}else{t.modoOffLine=!1;let e="";e="COMPRAS"===t.tipoTran?"HOY"===t.parametro?"/facturas/":"/facturas/v2/":"HOY"===t.parametro?"/prestamo/cobros/":"/cobros/v2/",yield t.loaderSvc.show("Cargando"),t.apiSvc.get(e+t.authSvc.getUserInfo().usuario+"/"+t.fecIni.toString()+"/"+t.fecFin.toString()).subscribe(r=>{t.loaderSvc.stop(),t.compras=r,t.congigurarDatos(t.compras)},r=>{t.loaderSvc.stop(),t.alertSvc.error("Error al obtener datos:"+r.error.message)})}})()}congigurarDatos(t){this.compras=t.map(e=>Object.assign(e,{importe:Number(e.facturaDetalle.reduce((r,i)=>r+Number(Number(Number(i.total).toFixed(0))),0))})),this.compras=t.map(e=>Object.assign(e,{precioUnitario:Number(e.facturaDetalle.reduce((r,i)=>r+Number(Number(Number(i.total).toFixed(0))),0))})),this.compras=t.map(e=>Object.assign(e,{importePago:e.valores?Number(e.valores.reduce((r,i)=>r+("R"===i.tipoPago?0:Number(Number(Number(i.monto).toFixed(0)))),0)):0})),this.comprasPagadas=this.compras.filter(e=>"P"===e.estado||"PP"===e.estado),this.comprasRealizadas=this.compras.filter(e=>"P"===e.estado||"PP"===e.estado||"A"===e.estado),this.comprasApagar=this.compras.filter(e=>"A"===e.estado),this.totalPagado=this.comprasPagadas.reduce((e,r)=>Number(e)+Number(r.importe),0),this.totalComprado=this.comprasRealizadas.reduce((e,r)=>Number(e)+Number(r.importe),0),this.totalPagadoNeto=this.comprasPagadas.reduce((e,r)=>Number(e)+Number(r.importePago),0),this.totalApagar=this.comprasApagar.reduce((e,r)=>Number(e)+Number(r.importe),0)}BTN_ARRAY(t,e){let r=[];return e.forEach((i,n)=>{t.forEach(m=>{n===m&&r.push(i)})}),r}Acciones(t){var e=this;return(0,l.A)(function*(){e.BTN_OPTION_MORE=[{text:"Ver transaccion",role:"destructive",icon:"folder-open-outline",handler:()=>{}},{text:"Pagar",role:"destructive",icon:"wallet-outline",handler:()=>{e.pagar(t)}},{text:"P"===t.tipoFactura?"Anular Cobro Prest.":"Anular Pago",role:"destructive",icon:"trash-bin-outline",handler:()=>{"P"===t.tipoFactura?e.deleteCobroPrestamo(t):e.deletePagoConfirm(t)}},{text:"Anular Transaccion",role:"destructive",icon:"trash",handler:()=>{e.deleteTransaccionConfirm(t)}},{text:"Cancelar",icon:"close",role:"cancel",handler:()=>{console.log("Cancel clicked")}},{text:"Re-Imp. Rec.Acopio",icon:"print",role:"destructive",handler:()=>{e.doPrint(t,"Recibo de Acopio")}},{text:"Re-Imp. Rec.Dinero",icon:"print",role:"destructive",handler:()=>{e.doPrint(t,"Recibo de Dinero")}}],e.index_prestamo=t.valores?t.valores.indexOf(t.valores.find(i=>"P"===i.tipoPago)):-1,e.tipoFactura=t.tipoFactura,e.BTN_OPTION_MORE_ACTIVE="P"===t.estado.trim()&&-1!==e.index_prestamo&&"P"!==t.tipoFactura.trim()&&"G"!==t.tipoFactura.trim()?e.BTN_ARRAY([2,4,5,6],e.BTN_OPTION_MORE):"P"!==t.estado.trim()&&"PP"!==t.estado.trim()||-1!==e.index_prestamo||"MP"!==t.tipoFactura.trim()?"P"===t.estado.trim()&&"P"===t.tipoFactura.trim()?e.BTN_ARRAY([2,4,6],e.BTN_OPTION_MORE):"P"===t.estado.trim()&&-1===e.index_prestamo&&"G"===t.tipoFactura.trim()?e.BTN_ARRAY([2,4],e.BTN_OPTION_MORE):"A"===t.estado.trim()&&"P"!==t.tipoFactura.trim()?e.BTN_ARRAY([1,3,4],e.BTN_OPTION_MORE):("C"===t.estado.trim()&&t.tipoFactura.trim(),e.BTN_ARRAY([4],e.BTN_OPTION_MORE)):e.BTN_ARRAY([2,4,5],e.BTN_OPTION_MORE),yield(yield e.actionCtrl.create({header:"Opciones",buttons:e.BTN_OPTION_MORE_ACTIVE})).present()})()}deleteTransaccionConfirm(t){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular la transaccion?",buttons:[{text:"Si",handler:()=>{e.jmjModoConexionService.getModoOffLine()?(e.compras=e.compras.filter(i=>i.codigoTransaccion!==t.codigoTransaccion),e.jmjStorageService.saveData(e.jmjStorageService.COMPRAS,JSON.stringify(e.compras))):e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/facturas/cancelacionCompra/"+t.codigoTransaccion,null).subscribe(i=>{e.loaderSvc.stop(),e.alertSvc.success("Transaccion Anulada!"),e.compras=e.compras.filter(n=>n.codigoTransaccion!==t.codigoTransaccion)},i=>{e.loaderSvc.stop(),console.log(i.error),e.alertSvc.error(i.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}deletePagoConfirm(t){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular el Pago?",buttons:[{text:"Si",handler:()=>{if(e.jmjModoConexionService.getModoOffLine()){let i=e.compras.findIndex(n=>n.codigoTransaccion===t.codigoTransaccion);-1!==i&&(e.compras[i].estado="A",e.compras[i].valores=null),e.jmjStorageService.saveData(e.jmjStorageService.COMPRAS,JSON.stringify(e.compras))}else e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/facturas/cancelacionPago/"+t.codigoTransaccion,null).subscribe(i=>{e.loaderSvc.stop(),e.alertSvc.success("Pago Anulado!"),e.recuperarDatos()},i=>{e.loaderSvc.stop(),console.log(i.error),e.alertSvc.error(i.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}deleteCobroPrestamo(t){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular el Cobro del Pr\xe9stamo?",buttons:[{text:"Si",handler:()=>{e.jmjModoConexionService.getModoOffLine()?e.alertSvc.error("Solo pueden anularse pr\xe9stamos en modo On-Line"):e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/prestamo/cancelacionCobro/"+t.codigoTransaccion,null).subscribe(i=>{e.loaderSvc.stop(),e.alertSvc.success("Cobro Anulado!"),e.recuperarDatos()},i=>{e.loaderSvc.stop(),console.log(i.error),e.alertSvc.error(i.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}pagar(t){var e=this;return(0,l.A)(function*(){yield e.prepararDatos(t);const r=yield e.modalCtrl.create({component:A.J,componentProps:{proveedor:e.iJmjPagoProveedor,facturas:e.iJmjCompras,totalAmountGS:e.iJmjCompras[0].precioUnitario,tipoFactura:e.tipoFactura,pagoOffLine:!0}});yield r.present();const{data:i}=yield r.onDidDismiss();i&&i.success?(console.log("Pago exitoso"),e.alertSvc.success("Pago Exitoso!"),e.recuperarDatos()):(i?e.presentAlertMultipleButtons(i.success?i.imprimioTicket?"":"Impresi\xf3n cancelada por el usuario":"Pago cancelado por el usuario"):e.alertSvc.error("Pago Fallido!"),console.log("Pago fallido"))})()}presentAlertMultipleButtons(t){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Aviso",subHeader:"Pago Incompleto",message:t,buttons:["Entendido"]})).present()})()}doPrint(t,e){var r=this;return(0,l.A)(function*(){r.selectedPrinter||r.presentToast("Debe seleccionar una impresora"),yield r.prepararDatos(t),(yield r.alertCtrl.create({header:"Confirmaci\xf3n",message:"Tipo de Impresion",buttons:[{text:"Original",handler:()=>{r.loaderSvc.show("Imprimiendo original..").then((0,l.A)(function*(){"Recibo de Acopio"===e?(yield r.buildTicket(r.iJmjCompras,"N"),yield r.print(r.ticket)):"Recibo de Dinero"===e&&(yield r.buildTicketPrestamo(r.iJmjCompras,"N"),yield r.print(r.ticketPrestamo)),r.loaderSvc.stop()}))}},{text:"Copia",handler:()=>{r.loaderSvc.show("Imprimiendo copia..").then((0,l.A)(function*(){"Recibo de Acopio"===e?(yield r.buildTicket(r.iJmjCompras,"S"),yield r.print(r.ticket)):"Recibo de Dinero"===e&&(yield r.buildTicketPrestamo(r.iJmjCompras,"S"),yield r.print(r.ticketPrestamo)),r.loaderSvc.stop()}))}}]})).present()})()}prepararDatos(t){var e=this;return(0,l.A)(function*(){if(e.iJmjProductoMpArray=[],t.facturaDetalle.map(r=>{e.iJmjProductoMp={id:e.iJmjProductoMpArray.length+1,codigoArticulo:r.codigoArticulo,descripcionArticulo:r.nombreArticulo,precioUnitario:Number(Number(r.precioUnitario).toFixed(0)),lote:r.lote||null,pesoBruto:r.pesoBruto||0,vencimientoLote:r.vencimientoLote||null,vencimientoLoteCorto:r.vencimientoLote||null,tara:r.tara||0,cantidad:r.cantidad||0,envaseComprador:r.envaseComprador,densidad:r.densidad||0,solubilidad:r.solubilidad||0,fucsina:r.fucsina||0,facturacion:"S",parcela:null,aprovisionamientoQm:null,claveControl:null},e.iJmjProductoMpArray.push(e.iJmjProductoMp)}),e.iJmjPagoProveedor={id:t.codigoProveedor,nombre:t.proveedor,tipoDocumento:"COD",nroDocumento:t.codigoProveedor,nombre_factura:t.proveedor,ruc_factura:t.codigoProveedor,codigoPrestamo:null,montoPrestamo:0,saldoPrestamo:0,montoCuotaAcordado:0,detallePrestamo:null,detalleAprobaciones:null},"MP"===t.tipoFactura){let r=JSON.parse(yield e.jmjStorageService.getData(e.jmjStorageService.PROVEEDORES)),i=r.indexOf(r.find(m=>m.codigoProveedor===t.codigoProveedor));if(i<0)return void e.alertSvc.error("No se pudo obtener datos de prestamo del proveedor");let n=r[i];e.iJmjPagoProveedor.codigoPrestamo=n.codigoPrestamo,e.iJmjPagoProveedor.montoPrestamo=n.montoPrestamo,e.iJmjPagoProveedor.saldoPrestamo=n.saldoPrestamo,e.iJmjPagoProveedor.montoCuotaAcordado=n.montoCuotaAcordado,e.iJmjPagoProveedor.detallePrestamo=n.detallePrestamo}e.iJmjCompras=[],e.iJmjCompra={codigoProveedor:t.codigoProveedor,nombreProveedor:t.proveedor,tipoDocProveedor:"COD",nroDocProveedor:t.codigoProveedor,codigoTransaccion:t.codigoTransaccion,nroDoc:t.nroRecibo,monedaTransaccion:"GS",ctz:1,estado:t.estado,usuario:e.authSvc.getUserInfo().usuario,fechaHoraFactura:g().format("DD/MM/YYYY")+" "+g().format("HH:mm"),precioUnitario:Number(Number(t.importe).toFixed(0)),tipoFactura:t.tipoFactura,facturaDetalle:e.iJmjProductoMpArray,tipoComprobante:t.tipoComprobante,facturacion:"MP"===t.tipoComprobante?"S":"N",timbrado:t.timbrado,nroRecibo:t.nroRecibo||0,nroFactura:t.nroFactura||0,offLine:t.offLine,comentario:null,talonario:t.talonario||null,valores:null},e.iJmjCompras.push(e.iJmjCompra),e.iJmjValores=[],t.valores&&t.valores.map(r=>{e.iJmjValor={cuota:null,destipovalor:r.tipoPago,idmoneda:"GS",importe:r.monto,importeGS:r.monto,ctz:1,fecha:r.fecha||r.fechaHoraPago,idtipovalor:r.tipoPago,banco:null,desbanco:null,fecvalor:r.fecha||r.fechaHoraPago,nrovalor:r.nroDocumento||r.docNum,nrocuenta:r.nroCuenta||r.nrocuenta,siglas:e.iJmjTiposPago.find(i=>i.abrev===r.tipoPago).nombre,orden:1},e.iJmjValores.push(e.iJmjValor)})})()}buildTicket(t,e){var r=this;return(0,l.A)(function*(){r.ticket.trim().flush(),r.ticket.clear();let i="";i="Ctz:"+1..toFixed(2),r.ticketData={movId:t[0].codigoTransaccion,fecHoraMov:t[0].fechaHoraFactura,nroFisico:t[0].nroRecibo,personaId:t[0].codigoProveedor,personaNom:t[0].nombreProveedor,proveedorNom:t[0].nombreProveedor,moneda:"GS",ctz:i.toString(),impresoId:r.authSvc.getUserInfo().usuario,emitidoPor:r.authSvc.getUserInfo().nombre,totalDocumentos:t[0].precioUnitario,totalValores:Number(r.iJmjValores.reduce((n,m)=>n+m.importeGS,0)),detalles:r.iJmjCompras,valores:r.iJmjValores,tipoTicket:"S"===e?"Copia":"Original"},r.ticket=r.ticketService.buildTicket(r.ticketData)})()}buildTicketPrestamo(t,e){var r=this;return(0,l.A)(function*(){r.ticketPrestamo.trim().flush(),r.ticketPrestamo.clear();let i="";i="Ctz:"+1..toFixed(2),"COBROS"===r.tipoTran&&(r.index_prestamo=0);let n=-1===r.index_prestamo?0:r.iJmjValores[r.index_prestamo].importeGS;r.ticketData={movId:t[0].codigoTransaccion,fecHoraMov:t[0].fechaHoraFactura,nroFisico:t[0].nroRecibo,personaId:t[0].codigoProveedor,personaNom:t[0].nombreProveedor,proveedorNom:t[0].nombreProveedor,moneda:"GS",ctz:i.toString(),impresoId:r.authSvc.getUserInfo().usuario,emitidoPor:r.authSvc.getUserInfo().nombre,totalDocumentos:n,totalValores:n,detalles:r.iJmjCompras,valores:r.iJmjValores,tipoTicket:"S"===e?"Copia":"Original",totalEnLetras:r.jmjNroALetraService.NumeroALetras(n)},r.ticketPrestamo=r.ticketPrestamoService.buildTicket(r.ticketData)})()}presentToast(t){var e=this;return(0,l.A)(function*(){(yield e.toastController.create({message:t,duration:2e3})).present()})()}getPrinters(){this.printSvc.searchBluetoothPrinter().then(t=>{this.bluetoothList=t.filter(e=>T.c.impresora.includes(e.name)),this.selectedPrinter=this.bluetoothList.length>0?this.bluetoothList.filter(e=>T.c.impresora.includes(e.name))[0]:null})}selectPrinter(){var t=this;return(0,l.A)(function*(){t.getPrinters();const e=yield t.modalCtrl.create({component:R.i,componentProps:{impresoras:t.bluetoothList,selectedPrinter:t.selectedPrinter}});yield e.present();const{data:r}=yield e.onDidDismiss();r&&(t.selectedPrinter=r.impresora,t.presentToast(t.selectPrinter))})()}print(t){var e=this;return(0,l.A)(function*(){e.selectedPrinter||e.presentToast("Debe seleccionar una impresora");try{let n,r=t.buffer.length,i=t.buffer.reverse().findIndex(C=>0!==C);-1!==i&&(n=r-i),t.buffer.reverse();let m=2*n,p=1024;p=m<1024?1024:m>=1024&&m<2048?2048:4096;let h=new P.L(p,2);h.write(t.buffer.subarray(0,n)),yield e.printSvc.sendToBluetoothPrinter(e.selectedPrinter.id,h.buffer)}catch(r){e.alertSvc.error(r)}})()}abrirParametros(){var t=this;return(0,l.A)(function*(){const e=yield t.popoverCtrl.create({component:x.n});yield e.present();const{data:r}=yield e.onWillDismiss();r&&(t.parametro=r.id,t.fecIni=r.fechaIni,t.fecFin=r.fechaFin,t.parametros="HOY"===t.parametro?t.fecIni:t.fecIni+" al "+t.fecFin,t.recuperarDatos())})()}close(){this.navCtrl.navigateBack("/jmj-home")}static{this.\u0275fac=function(e){return new(e||a)(o.rXU(N.B),o.rXU(F.y),o.rXU(f.nX),o.rXU(z.V),o.rXU(j.a),o.rXU(_.G),o.rXU(I.B),o.rXU(c.GD),o.rXU(c.W3),o.rXU(c.hG),o.rXU(M.w),o.rXU(J.q9),o.rXU(b.u),o.rXU(c.K_),o.rXU(c.IE),o.rXU(E.u),o.rXU(D.Z))}}static{this.\u0275cmp=o.VBU({type:a,selectors:[["app-jmj-compra-hist"]],decls:12,vars:4,consts:[[3,"title"],[1,"toolbar","ion-text-center","header-title"],["right",""],[3,"click"],["name","print","slot","icon-only"],["right","",3,"click",4,"ngIf"],["slot","fixed",3,"ionRefresh"],["pullingIcon","chevron-down-circle-outline","pullingText","Pull to refresh","refreshingSpinner","circles","refreshingText","Refrescando..."],[4,"ngIf"],["right","",3,"click"],["slot","icon-only","ios","ellipsis-horizontal","md","ellipsis-vertical"],[1,"ion-justify-content-center"],["size","12"],["size-xs","1.5","size-sm","1.1","size-md","1.5","size-lg","1","size-xl","1",1,"ion-text-start"],["size-xs","2.5","size-sm","1.9","size-md","1","size-lg","1","size-xl","1",1,"ion-text-center"],["size-xs","1.3","size-sm","1","size-md","0.8","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-center"],["size-xs","1.7","size-sm","1","size-md","1","size-lg","1","size-xl","1",1,"ion-text-end"],["size-xs","1.9","size-sm","1","size-md","1.5","size-lg","1","size-xl","1",1,"ion-text-end"],["size-xs","3.5","size-sm","2.5","size-md","2.5","size-lg","1","size-xl","1",1,"ion-text-end"],["size-xs","3.5","size-sm","2.5","size-md","2.5","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-end"],["size-xs","1.2","size-sm","1","size-md","1","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-end"],["class","datarow",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"datarow",3,"click","ngClass"],["size-xs","0.8","size-sm","0.8","size-md","0.5","size-lg","1","size-xl","1",1,"ion-text-start"],["size-xs","3","size-sm","2.2","size-md","2","size-lg","1","size-xl","1",1,"ion-text-center"],["size-xs","1.3","size-sm","1.1","size-md","1","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-center"],["size-xs","2","size-sm","1.2","size-md","1","size-lg","1","size-xl","1",1,"ion-text-center"],["size-xs","2.5","size-sm","1.2","size-md","1","size-lg","1","size-xl","1",1,"ion-text-center"],["class","ion-text-end","size-xs","3.5","size-sm","2.2","size-md","2.8","size-lg","1","size-xl","1",4,"ngIf"],["size-xs","3.5","size-sm","2.2","size-md","2.2","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-end"],["size-xs","1","size-sm","1","size-md","1","size-lg","1","size-xl","1",1,"ion-hide-sm-down","ion-text-center"],["size-xs","3.5","size-sm","2.2","size-md","2.8","size-lg","1","size-xl","1",1,"ion-text-end"],["size","12","size-md","4",1,"ion-text-end"],[1,"ion-text-end"],[1,"ion-text-center","ion-padding-end"],[1,"total"]],template:function(e,r){1&e&&(o.j41(0,"app-header",0)(1,"ion-toolbar",1)(2,"p"),o.EFF(3),o.k0s()(),o.j41(4,"div",2)(5,"ion-button",3),o.bIt("click",function(){return r.selectPrinter()}),o.nrm(6,"ion-icon",4),o.k0s(),o.DNE(7,B,2,0,"ion-button",5),o.k0s()(),o.j41(8,"ion-content")(9,"ion-refresher",6),o.bIt("ionRefresh",function(n){return r.doRefresh(n)}),o.nrm(10,"ion-refresher-content",7),o.k0s(),o.DNE(11,$,26,5,"ion-grid",8),o.k0s()),2&e&&(o.Y8G("title",r.titulo),o.R7$(3),o.JRh(r.parametros),o.R7$(4),o.Y8G("ngIf",!r.modoOffLine),o.R7$(4),o.Y8G("ngIf",r.compras.length>0))},dependencies:[u.YU,u.Sq,u.bT,c.Jm,c.hU,c.W9,c.lO,c.iq,c.uz,c.he,c.nf,c.To,c.Ki,c.ln,c.ai,k.l,u.QX],styles:[".toolbar[_ngcontent-%COMP%]{height:40px;margin-top:0;margin-bottom:-10px}.toolbar[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:0;margin-bottom:0}.datarow[_ngcontent-%COMP%]{font-size:.8rem}.R[_ngcontent-%COMP%]{color:red}.A[_ngcontent-%COMP%], .PP[_ngcontent-%COMP%]{color:orange}.P[_ngcontent-%COMP%]{color:green}ion-icon[_ngcontent-%COMP%]{color:#fff}"]})}}return a})()}];let X=(()=>{class a{static{this.\u0275fac=function(e){return new(e||a)}}static{this.\u0275mod=o.$C({type:a})}static{this.\u0275inj=o.G2t({imports:[f.iI.forChild(V),f.iI]})}}return a})();var w=s(9244);let Q=(()=>{class a{static{this.\u0275fac=function(e){return new(e||a)}}static{this.\u0275mod=o.$C({type:a})}static{this.\u0275inj=o.G2t({imports:[u.MD,O.YN,c.bv,X,w.Q]})}}return a})()}}]);