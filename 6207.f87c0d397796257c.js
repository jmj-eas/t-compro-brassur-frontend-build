"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6207],{6207:(ee,S,c)=>{c.r(S),c.d(S,{JmjCompraHistPageModule:()=>X});var u=c(177),O=c(9417),m=c(7343),v=c(1050),l=c(467),g=c(7586),P=c(8448),N=c(8765),A=c(1432),T=c(5312),R=c(7469),t=c(4438),j=c(2767),F=c(3943),M=c(6356),x=c(4615),b=c(2130),I=c(9777),D=c(5032),y=c(3239),E=c(2464),J=c(1527),_=c(5161),z=c(385);const B=s=>[s];function U(s,f){if(1&s){const o=t.RV6();t.j41(0,"ion-row",15),t.bIt("click",function(){const r=t.eBV(o).$implicit,a=t.XpG(2);return t.Njj(a.Acciones(r))}),t.j41(1,"ion-col",8),t.EFF(2),t.k0s(),t.j41(3,"ion-col",9),t.EFF(4),t.k0s(),t.j41(5,"ion-col",10),t.EFF(6),t.k0s(),t.j41(7,"ion-col",11),t.EFF(8),t.k0s(),t.j41(9,"ion-col",12),t.EFF(10),t.nI1(11,"number"),t.k0s()()}if(2&s){const o=f.$implicit;t.Y8G("ngClass",t.eq3(9,B,o.estado)),t.R7$(2),t.JRh(o.fechaHoraFactura),t.R7$(2),t.JRh(o.docNum||o.movimiento),t.R7$(2),t.JRh(o.proveedor),t.R7$(2),t.JRh(o.concepto_descripcion),t.R7$(2),t.JRh(t.i5U(11,6,o.importe,"1.0-0"))}}function k(s,f){if(1&s&&(t.j41(0,"div")(1,"ion-col",16)(2,"ion-item",17)(3,"ion-label",18)(4,"span"),t.EFF(5,"TOTAL: "),t.k0s()(),t.j41(6,"p",19),t.EFF(7),t.nI1(8,"number"),t.k0s()()()()),2&s){const o=t.XpG(2);t.R7$(7),t.JRh(t.i5U(8,1,o.totalPagado,"1.0-0"))}}function Y(s,f){if(1&s&&(t.j41(0,"div")(1,"ion-col",16)(2,"ion-item",17)(3,"ion-label",18),t.EFF(4,"COBRADO: "),t.k0s(),t.j41(5,"p",19),t.EFF(6),t.nI1(7,"number"),t.k0s()()()()),2&s){const o=t.XpG(2);t.R7$(6),t.JRh(t.i5U(7,1,o.totalPagadoNeto,"1.0-0"))}}function L(s,f){if(1&s&&(t.j41(0,"ion-grid")(1,"ion-row",6)(2,"ion-col",7)(3,"ion-list")(4,"ion-grid")(5,"ion-row")(6,"ion-col",8),t.EFF(7,"Fecha"),t.k0s(),t.j41(8,"ion-col",9),t.EFF(9,"Nro"),t.k0s(),t.j41(10,"ion-col",10),t.EFF(11,"Prov"),t.k0s(),t.j41(12,"ion-col",11),t.EFF(13,"Concepto"),t.k0s(),t.j41(14,"ion-col",12),t.EFF(15,"Importe"),t.k0s()(),t.DNE(16,U,12,11,"ion-row",13),t.j41(17,"ion-row",14),t.DNE(18,k,9,4,"div",5)(19,Y,8,4,"div",5),t.k0s()()()()()()),2&s){const o=t.XpG();t.R7$(16),t.Y8G("ngForOf",o.compras),t.R7$(2),t.Y8G("ngIf","COMPRAS"===o.tipoTran),t.R7$(),t.Y8G("ngIf","COBROS"===o.tipoTran)}}const G=[{path:":tipoTran",component:(()=>{class s{constructor(o,e,r,a,i,n,d,p,h,C,$,w,Q,W,K,Z,q){this.jmjModoConexionService=o,this.jmjStorageService=e,this.route=r,this.jmjNroALetraService=a,this.ticketPrestamoService=i,this.apiSvc=n,this.printSvc=d,this.actionCtrl=p,this.modalCtrl=h,this.alertCtrl=C,this.ticketService=$,this.navCtrl=w,this.authSvc=Q,this.toastController=W,this.popoverCtrl=K,this.alertSvc=Z,this.loaderSvc=q,this.tipoFactura=null,this.compras=[],this.ticket=new P.L(0,2),this.ticketPrestamo=new P.L(0,2),this.bluetoothList=[],this.selectedPrinter=null,this.comprasRealizadas={},this.comprasPagadas={},this.comprasApagar={},this.totalComprado=0,this.totalPagado=0,this.totalPagadoNeto=0,this.totalApagar=0,this.index_prestamo=-1,this.parametro="HOY",this.modoOffLine=!1,this.fecIni=g().format("DD/MM/YYYY"),this.fecFin=g().format("DD/MM/YYYY"),this.parametros=g().format("DD/MM/YYYY"),this.BTN_OPTION_MORE_ACTIVE=[{}],this.BTN_OPTION_MORE=[{}],this.tipoTran=this.route.snapshot.paramMap.get("tipoTran"),"COMPRAS"===this.tipoTran?(this.titulo="Compras Realizadas",this.tituloMto="Importe",this.tituloPag="Imp.Pago"):(this.titulo="Cobros Pr\xe9stamos Realizados",this.tituloMto="Saldo Pr.",this.tituloPag="Imp.Cobro")}ngOnInit(){this.getPrinters(),this.recuperarDatos()}doRefresh(o){var e=this;return(0,l.A)(function*(){e.jmjModoConexionService.getModoOffLine()?o.target.complete():(yield e.recuperarDatos(),o.target.complete(),setTimeout(()=>{o.target.complete()},2e3))})()}recuperarDatos(){var o=this;return(0,l.A)(function*(){if("COMPRAS"===o.tipoTran)if(o.iJmjTiposPago=JSON.parse(yield o.jmjStorageService.getData(o.jmjStorageService.TIPOS_PAGOS)),o.jmjModoConexionService.getModoOffLine()){if(o.modoOffLine=!0,o.iJmjCompra=null,o.iJmjCompras=[],o.compras=[],o.transacciones={},o.transacciones=JSON.parse(yield o.jmjStorageService.getData(o.jmjStorageService.COMPRAS)),!o.transacciones)return void o.alertSvc.info("No existen datos");for(const e of o.transacciones){const r=Object.assign({},{codigoProveedor:e.codigoProveedor,codigoTransaccion:e.codigoTransaccion,docNum:null,usuario:e.usuario,estado:e.estado,facturaDetalle:e.facturaDetalle.map(a=>({cantidad:a.cantidad,codigoArticulo:a.codigoArticulo,facturacion:a.facturacion,lote:a.lote,nombreArticulo:a.descripcionArticulo?a.descripcionArticulo:a.nombreArticulo,pesoBruto:a.pesoBruto,precioUnitario:a.precioUnitario,tara:a.tara,total:Number(Number(Number(a.precioUnitario).toFixed(0))*Number(a.cantidad)).toFixed(0),vencimientoLote:a.vencimientoLote,densidad:a.densidad?parseFloat(a.densidad.toString().replace(/\,/g,".")):0,fucsina:a.fucsina||0,solubilidad:a.solubilidad||0,envaseComprador:a.envaseComprador})),facturacion:e.facturacion,fechaHoraFactura:e.fechaHoraFactura,identificador:e.codigoTransaccion,importe:0,precioUnitario:0,nroRecibo:e.nroRecibo,proveedor:e.nombreProveedor?e.nombreProveedor:e.codigoProveedor,tipoComprobante:e.tipoComprobante,tipoFactura:e.tipoFactura,valores:e.valores?e.valores.map(a=>({docNum:a.nroDocumento,fechaHoraPago:a.fecha,monto:a.monto,tipoPago:a.tipoPago,nrocuenta:a.nrocuenta})):null});o.compras.push(r)}o.congigurarDatos(o.compras)}else{o.modoOffLine=!1;let e=0,r=0;const a=yield o.jmjStorageService.getData("CAJA_DATA");if(a&&"undefined"!==a){const i=JSON.parse(a);e=i.habilitacion||0,r=i.caja||0}if(!e||!r)return void o.alertSvc.error("No se encontraron datos de caja. Configure la caja primero.");yield o.loaderSvc.show("Cargando pagos realizados..."),o.apiSvc.get(`/facturas/facturahist?habilitacion=${e}&caja=${r}`).subscribe({next:i=>{o.loaderSvc.stop(),200===i.status&&i.data&&Array.isArray(i.data)?(o.compras=i.data.map(n=>{let d=n.fecha;if(d&&d.includes("-")){const p=d.split("-");3===p.length&&(d=`${p[2]}/${p[1]}/${p[0]}`)}return{codigoProveedor:n.persona||"",nombreProveedor:n.nombre_proveedor||"",codigoTransaccion:n.movimiento?n.movimiento.toString():"",docNum:n.nro_compra||(n.movimiento?n.movimiento.toString():""),usuario:n.usuario_insercion||"",estado:n.estado||"A",fechaHoraFactura:d,importe:n.importe?"string"==typeof n.importe?parseFloat(n.importe):Number(n.importe):0,precioUnitario:n.importe?"string"==typeof n.importe?parseFloat(n.importe):Number(n.importe):0,concepto:n.concepto||0,concepto_descripcion:n.concepto_descripcion||"",proveedor:n.nombre_proveedor||n.persona||"",tipoFactura:"SINF"===n.tipo_gasto?"G":"MP",tipoComprobante:n.tipo_comprobante||0,nroRecibo:null,identificador:n.movimiento?n.movimiento.toString():"",movimiento:n.movimiento,facturaDetalle:[],valores:null,importePago:parseFloat(n.importe)||0}}),o.congigurarDatos(o.compras)):(o.compras=[],o.congigurarDatos(o.compras))},error:i=>{o.loaderSvc.stop(),o.alertSvc.error("Error al obtener datos: "+(i.error?.message||i.message||"Error desconocido")),o.compras=[],o.congigurarDatos(o.compras)}})}})()}congigurarDatos(o){this.compras=o.map(e=>{let r=null!=e.importe?Number(e.importe):0;return null==e.importe&&e.facturaDetalle&&e.facturaDetalle.length>0&&(r=Number(e.facturaDetalle.reduce((a,i)=>a+Number(Number(Number(i.total).toFixed(0))),0))),Object.assign(e,{importe:r})}),this.compras=this.compras.map(e=>{let a=e.precioUnitario||e.importe||0;return!e.precioUnitario&&!e.importe&&e.facturaDetalle&&e.facturaDetalle.length>0&&(a=Number(e.facturaDetalle.reduce((i,n)=>i+Number(Number(Number(n.total).toFixed(0))),0))),Object.assign(e,{precioUnitario:a})}),this.compras=this.compras.map(e=>Object.assign(e,{importePago:e.valores?Number(e.valores.reduce((r,a)=>r+("R"===a.tipoPago?0:Number(Number(Number(a.monto).toFixed(0)))),0)):0})),this.comprasPagadas=this.compras.filter(e=>"P"===e.estado||"PP"===e.estado),this.comprasRealizadas=this.compras.filter(e=>"P"===e.estado||"PP"===e.estado||"A"===e.estado),this.comprasApagar=this.compras.filter(e=>"A"===e.estado),this.totalPagado="COMPRAS"===this.tipoTran?this.compras.reduce((e,r)=>{const a=Number(r.importe)||0;return Number(e)+a},0):this.comprasPagadas.reduce((e,r)=>{const a=Number(r.importe)||0;return Number(e)+a},0),this.totalComprado=this.comprasRealizadas.reduce((e,r)=>{const a=Number(r.importe)||0;return Number(e)+a},0),this.totalPagadoNeto=this.comprasPagadas.reduce((e,r)=>{const a=Number(r.importePago)||0;return Number(e)+a},0),this.totalApagar=this.comprasApagar.reduce((e,r)=>{const a=Number(r.importe)||0;return Number(e)+a},0)}BTN_ARRAY(o,e){let r=[];return e.forEach((a,i)=>{o.forEach(n=>{i===n&&r.push(a)})}),r}Acciones(o){var e=this;return(0,l.A)(function*(){"COMPRAS"===e.tipoTran?(e.BTN_OPTION_MORE=[{text:"Anular",role:"destructive",icon:"trash",handler:()=>{e.anularFactura(o)}},{text:"Cancelar",icon:"close",role:"cancel",handler:()=>{console.log("Cancel clicked")}}],e.BTN_OPTION_MORE_ACTIVE=e.BTN_OPTION_MORE):(e.BTN_OPTION_MORE=[{text:"Ver transaccion",role:"destructive",icon:"folder-open-outline",handler:()=>{}},{text:"Anular Transaccion",role:"destructive",icon:"trash",handler:()=>{e.deleteTransaccionConfirm(o)}},{text:"Cancelar",icon:"close",role:"cancel",handler:()=>{console.log("Cancel clicked")}}],e.index_prestamo=o.valores?o.valores.indexOf(o.valores.find(a=>"P"===a.tipoPago)):-1,e.tipoFactura=o.tipoFactura,e.BTN_OPTION_MORE_ACTIVE="P"===o.estado.trim()&&-1!==e.index_prestamo&&"P"!==o.tipoFactura.trim()&&"G"!==o.tipoFactura.trim()?e.BTN_ARRAY([2,4,5,6],e.BTN_OPTION_MORE):"P"!==o.estado.trim()&&"PP"!==o.estado.trim()||-1!==e.index_prestamo||"MP"!==o.tipoFactura.trim()?"P"===o.estado.trim()&&"P"===o.tipoFactura.trim()?e.BTN_ARRAY([2,4,6],e.BTN_OPTION_MORE):"P"===o.estado.trim()&&-1===e.index_prestamo&&"G"===o.tipoFactura.trim()?e.BTN_ARRAY([2,4],e.BTN_OPTION_MORE):"A"===o.estado.trim()&&"P"!==o.tipoFactura.trim()?e.BTN_ARRAY([1,3,4],e.BTN_OPTION_MORE):("C"===o.estado.trim()&&o.tipoFactura.trim(),e.BTN_ARRAY([4],e.BTN_OPTION_MORE)):e.BTN_ARRAY([2,4,5],e.BTN_OPTION_MORE)),yield(yield e.actionCtrl.create({header:"Opciones",buttons:e.BTN_OPTION_MORE_ACTIVE})).present()})()}anularFactura(o){var e=this;return(0,l.A)(function*(){o.movimiento?(yield e.loaderSvc.show("Anulando factura..."),e.apiSvc.delete("/facturas/factura",{body:{movimiento:o.movimiento}}).subscribe({next:r=>{e.loaderSvc.stop(),200===r.status?(e.alertSvc.success(r.message||"Factura anulada exitosamente"),e.recuperarDatos()):e.alertSvc.error(r.message||"Error al anular la factura")},error:r=>{e.loaderSvc.stop(),console.log("Error al anular:",r),e.alertSvc.error(r.error?.message||r.message||"Error al anular la factura")}})):e.alertSvc.error("No se encontr\xf3 el n\xfamero de movimiento")})()}deleteTransaccionConfirm(o){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular la transaccion?",buttons:[{text:"Si",handler:()=>{e.jmjModoConexionService.getModoOffLine()?(e.compras=e.compras.filter(a=>a.codigoTransaccion!==o.codigoTransaccion),e.jmjStorageService.saveData(e.jmjStorageService.COMPRAS,JSON.stringify(e.compras))):e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/facturas/cancelacionCompra/"+o.codigoTransaccion,null).subscribe(a=>{e.loaderSvc.stop(),e.alertSvc.success("Transaccion Anulada!"),e.compras=e.compras.filter(i=>i.codigoTransaccion!==o.codigoTransaccion)},a=>{e.loaderSvc.stop(),console.log(a.error),e.alertSvc.error(a.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}deletePagoConfirm(o){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular el Pago?",buttons:[{text:"Si",handler:()=>{if(e.jmjModoConexionService.getModoOffLine()){let a=e.compras.findIndex(i=>i.codigoTransaccion===o.codigoTransaccion);-1!==a&&(e.compras[a].estado="A",e.compras[a].valores=null),e.jmjStorageService.saveData(e.jmjStorageService.COMPRAS,JSON.stringify(e.compras))}else e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/facturas/cancelacionPago/"+o.codigoTransaccion,null).subscribe(a=>{e.loaderSvc.stop(),e.alertSvc.success("Pago Anulado!"),e.recuperarDatos()},a=>{e.loaderSvc.stop(),console.log(a.error),e.alertSvc.error(a.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}deleteCobroPrestamo(o){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Confirmaci\xf3n",message:"\xbfEst\xe1s seguro de Anular el Cobro del Pr\xe9stamo?",buttons:[{text:"Si",handler:()=>{e.jmjModoConexionService.getModoOffLine()?e.alertSvc.error("Solo pueden anularse pr\xe9stamos en modo On-Line"):e.loaderSvc.show("Anulando").then(()=>{e.apiSvc.post("/prestamo/cancelacionCobro/"+o.codigoTransaccion,null).subscribe(a=>{e.loaderSvc.stop(),e.alertSvc.success("Cobro Anulado!"),e.recuperarDatos()},a=>{e.loaderSvc.stop(),console.log(a.error),e.alertSvc.error(a.error.message.errors[0])})})}},{text:"No",role:"cancel",cssClass:"secondary"}]})).present()})()}pagar(o){var e=this;return(0,l.A)(function*(){yield e.prepararDatos(o);const r=yield e.modalCtrl.create({component:R.J,componentProps:{proveedor:e.iJmjPagoProveedor,facturas:e.iJmjCompras,totalAmountGS:e.iJmjCompras[0].precioUnitario,tipoFactura:e.tipoFactura,pagoOffLine:!0}});yield r.present();const{data:a}=yield r.onDidDismiss();a&&a.success?(console.log("Pago exitoso"),e.alertSvc.success("Pago Exitoso!"),e.recuperarDatos()):(a?e.presentAlertMultipleButtons(a.success?a.imprimioTicket?"":"Impresi\xf3n cancelada por el usuario":"Pago cancelado por el usuario"):e.alertSvc.error("Pago Fallido!"),console.log("Pago fallido"))})()}presentAlertMultipleButtons(o){var e=this;return(0,l.A)(function*(){yield(yield e.alertCtrl.create({header:"Aviso",subHeader:"Pago Incompleto",message:o,buttons:["Entendido"]})).present()})()}doPrint(o,e){var r=this;return(0,l.A)(function*(){r.selectedPrinter||r.presentToast("Debe seleccionar una impresora"),yield r.prepararDatos(o),(yield r.alertCtrl.create({header:"Confirmaci\xf3n",message:"Tipo de Impresion",buttons:[{text:"Original",handler:()=>{r.loaderSvc.show("Imprimiendo original..").then((0,l.A)(function*(){"Recibo de Acopio"===e?(yield r.buildTicket(r.iJmjCompras,"N"),yield r.print(r.ticket)):"Recibo de Dinero"===e&&(yield r.buildTicketPrestamo(r.iJmjCompras,"N"),yield r.print(r.ticketPrestamo)),r.loaderSvc.stop()}))}},{text:"Copia",handler:()=>{r.loaderSvc.show("Imprimiendo copia..").then((0,l.A)(function*(){"Recibo de Acopio"===e?(yield r.buildTicket(r.iJmjCompras,"S"),yield r.print(r.ticket)):"Recibo de Dinero"===e&&(yield r.buildTicketPrestamo(r.iJmjCompras,"S"),yield r.print(r.ticketPrestamo)),r.loaderSvc.stop()}))}}]})).present()})()}prepararDatos(o){var e=this;return(0,l.A)(function*(){if(e.iJmjProductoMpArray=[],o.facturaDetalle.map(r=>{e.iJmjProductoMp={id:e.iJmjProductoMpArray.length+1,codigoArticulo:r.codigoArticulo,descripcionArticulo:r.nombreArticulo,precioUnitario:Number(Number(r.precioUnitario).toFixed(0)),lote:r.lote||null,pesoBruto:r.pesoBruto||0,vencimientoLote:r.vencimientoLote||null,vencimientoLoteCorto:r.vencimientoLote||null,tara:r.tara||0,cantidad:r.cantidad||0,envaseComprador:r.envaseComprador,densidad:r.densidad||0,solubilidad:r.solubilidad||0,fucsina:r.fucsina||0,facturacion:"S",parcela:null,aprovisionamientoQm:null,claveControl:null},e.iJmjProductoMpArray.push(e.iJmjProductoMp)}),e.iJmjPagoProveedor={id:o.codigoProveedor,nombre:o.proveedor,tipoDocumento:"COD",nroDocumento:o.codigoProveedor,nombre_factura:o.proveedor,ruc_factura:o.codigoProveedor,codigoPrestamo:null,montoPrestamo:0,saldoPrestamo:0,montoCuotaAcordado:0,detallePrestamo:null,detalleAprobaciones:null},"MP"===o.tipoFactura){let r=JSON.parse(yield e.jmjStorageService.getData(e.jmjStorageService.PROVEEDORES)),a=r.indexOf(r.find(n=>n.codigoProveedor===o.codigoProveedor));if(a<0)return void e.alertSvc.error("No se pudo obtener datos de prestamo del proveedor");let i=r[a];e.iJmjPagoProveedor.codigoPrestamo=i.codigoPrestamo,e.iJmjPagoProveedor.montoPrestamo=i.montoPrestamo,e.iJmjPagoProveedor.saldoPrestamo=i.saldoPrestamo,e.iJmjPagoProveedor.montoCuotaAcordado=i.montoCuotaAcordado,e.iJmjPagoProveedor.detallePrestamo=i.detallePrestamo}e.iJmjCompras=[],e.iJmjCompra={codigoProveedor:o.codigoProveedor,nombreProveedor:o.proveedor,tipoDocProveedor:"COD",nroDocProveedor:o.codigoProveedor,codigoTransaccion:o.codigoTransaccion,nroDoc:o.nroRecibo,monedaTransaccion:"GS",ctz:1,estado:o.estado,usuario:e.authSvc.getUserInfo().usuario,fechaHoraFactura:g().format("DD/MM/YYYY")+" "+g().format("HH:mm"),precioUnitario:Number(Number(o.importe).toFixed(0)),tipoFactura:o.tipoFactura,facturaDetalle:e.iJmjProductoMpArray,tipoComprobante:o.tipoComprobante,facturacion:"MP"===o.tipoComprobante?"S":"N",timbrado:o.timbrado,nroRecibo:o.nroRecibo||0,nroFactura:o.nroFactura||0,offLine:o.offLine,comentario:null,talonario:o.talonario||null,valores:null},e.iJmjCompras.push(e.iJmjCompra),e.iJmjValores=[],o.valores&&o.valores.map(r=>{e.iJmjValor={cuota:null,destipovalor:r.tipoPago,idmoneda:"GS",importe:r.monto,importeGS:r.monto,ctz:1,fecha:r.fecha||r.fechaHoraPago,idtipovalor:r.tipoPago,banco:null,desbanco:null,fecvalor:r.fecha||r.fechaHoraPago,nrovalor:r.nroDocumento||r.docNum,nrocuenta:r.nroCuenta||r.nrocuenta,siglas:e.iJmjTiposPago.find(a=>a.abrev===r.tipoPago).nombre,orden:1},e.iJmjValores.push(e.iJmjValor)})})()}buildTicket(o,e){var r=this;return(0,l.A)(function*(){r.ticket.trim().flush(),r.ticket.clear();let a="";a="Ctz:"+1..toFixed(2),r.ticketData={movId:o[0].codigoTransaccion,fecHoraMov:o[0].fechaHoraFactura,nroFisico:o[0].nroRecibo,personaId:o[0].codigoProveedor,personaNom:o[0].nombreProveedor,proveedorNom:o[0].nombreProveedor,moneda:"GS",ctz:a.toString(),impresoId:r.authSvc.getUserInfo().usuario,emitidoPor:r.authSvc.getUserInfo().nombre,totalDocumentos:o[0].precioUnitario,totalValores:Number(r.iJmjValores.reduce((i,n)=>i+n.importeGS,0)),detalles:r.iJmjCompras,valores:r.iJmjValores,tipoTicket:"S"===e?"Copia":"Original"},r.ticket=r.ticketService.buildTicket(r.ticketData)})()}buildTicketPrestamo(o,e){var r=this;return(0,l.A)(function*(){r.ticketPrestamo.trim().flush(),r.ticketPrestamo.clear();let a="";a="Ctz:"+1..toFixed(2),"COBROS"===r.tipoTran&&(r.index_prestamo=0);let i=-1===r.index_prestamo?0:r.iJmjValores[r.index_prestamo].importeGS;r.ticketData={movId:o[0].codigoTransaccion,fecHoraMov:o[0].fechaHoraFactura,nroFisico:o[0].nroRecibo,personaId:o[0].codigoProveedor,personaNom:o[0].nombreProveedor,proveedorNom:o[0].nombreProveedor,moneda:"GS",ctz:a.toString(),impresoId:r.authSvc.getUserInfo().usuario,emitidoPor:r.authSvc.getUserInfo().nombre,totalDocumentos:i,totalValores:i,detalles:r.iJmjCompras,valores:r.iJmjValores,tipoTicket:"S"===e?"Copia":"Original",totalEnLetras:r.jmjNroALetraService.NumeroALetras(i)},r.ticketPrestamo=r.ticketPrestamoService.buildTicket(r.ticketData)})()}presentToast(o){var e=this;return(0,l.A)(function*(){(yield e.toastController.create({message:o,duration:2e3})).present()})()}getPrinters(){this.printSvc.searchBluetoothPrinter().then(o=>{this.bluetoothList=o.filter(e=>T.c.impresora.includes(e.name)),this.selectedPrinter=this.bluetoothList.length>0?this.bluetoothList.filter(e=>T.c.impresora.includes(e.name))[0]:null})}selectPrinter(){var o=this;return(0,l.A)(function*(){o.getPrinters();const e=yield o.modalCtrl.create({component:N.i,componentProps:{impresoras:o.bluetoothList,selectedPrinter:o.selectedPrinter}});yield e.present();const{data:r}=yield e.onDidDismiss();r&&(o.selectedPrinter=r.impresora,o.presentToast(o.selectPrinter))})()}print(o){var e=this;return(0,l.A)(function*(){e.selectedPrinter||e.presentToast("Debe seleccionar una impresora");try{let i,r=o.buffer.length,a=o.buffer.reverse().findIndex(C=>0!==C);-1!==a&&(i=r-a),o.buffer.reverse();let n=2*i,d=1024;d=n<1024?1024:n>=1024&&n<2048?2048:4096;let h=new P.L(d,2);h.write(o.buffer.subarray(0,i)),yield e.printSvc.sendToBluetoothPrinter(e.selectedPrinter.id,h.buffer)}catch(r){e.alertSvc.error(r)}})()}abrirParametros(){var o=this;return(0,l.A)(function*(){const e=yield o.popoverCtrl.create({component:A.n});yield e.present();const{data:r}=yield e.onWillDismiss();r&&(o.parametro=r.id,o.fecIni=r.fechaIni,o.fecFin=r.fechaFin,o.parametros="HOY"===o.parametro?o.fecIni:o.fecIni+" al "+o.fecFin,o.recuperarDatos())})()}close(){this.navCtrl.navigateBack("/jmj-home")}static{this.\u0275fac=function(e){return new(e||s)(t.rXU(j.B),t.rXU(F.y),t.rXU(v.nX),t.rXU(M.V),t.rXU(x.a),t.rXU(b.G),t.rXU(I.B),t.rXU(m.GD),t.rXU(m.W3),t.rXU(m.hG),t.rXU(y.w),t.rXU(D.q9),t.rXU(E.u),t.rXU(m.K_),t.rXU(m.IE),t.rXU(J.u),t.rXU(_.Z))}}static{this.\u0275cmp=t.VBU({type:s,selectors:[["app-jmj-compra-hist"]],decls:9,vars:3,consts:[[3,"title"],[1,"toolbar","ion-text-center","header-title"],["right",""],["slot","fixed",3,"ionRefresh"],["pullingIcon","chevron-down-circle-outline","pullingText","Pull to refresh","refreshingSpinner","circles","refreshingText","Refrescando..."],[4,"ngIf"],[1,"ion-justify-content-center"],["size","12"],["size-xs","2.5","size-sm","2","size-md","2","size-lg","2","size-xl","2",1,"ion-text-center"],["size-xs","1.5","size-sm","1.5","size-md","1.5","size-lg","1.5","size-xl","1.5",1,"ion-text-center"],["size-xs","3","size-sm","3","size-md","3","size-lg","3","size-xl","3",1,"ion-text-start"],["size-xs","2.5","size-sm","2.5","size-md","2.5","size-lg","2.5","size-xl","2.5",1,"ion-text-start"],["size-xs","2.5","size-sm","2","size-md","2","size-lg","2","size-xl","2",1,"ion-text-end"],["class","datarow",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"ion-justify-content-center","ion-margin-top"],[1,"datarow",3,"click","ngClass"],["size","12",1,"ion-text-center"],["lines","none",1,"ion-no-padding"],[1,"ion-text-start",2,"font-weight","bold","font-size","0.9rem"],[1,"total",2,"font-weight","bold","font-size","1rem","margin","0"]],template:function(e,r){1&e&&(t.j41(0,"app-header",0)(1,"ion-toolbar",1)(2,"p"),t.EFF(3),t.k0s()(),t.nrm(4,"div",2),t.k0s(),t.j41(5,"ion-content")(6,"ion-refresher",3),t.bIt("ionRefresh",function(i){return r.doRefresh(i)}),t.nrm(7,"ion-refresher-content",4),t.k0s(),t.DNE(8,L,20,3,"ion-grid",5),t.k0s()),2&e&&(t.Y8G("title",r.titulo),t.R7$(3),t.JRh(r.parametros),t.R7$(5),t.Y8G("ngIf",r.compras.length>0))},dependencies:[u.YU,u.Sq,u.bT,m.hU,m.W9,m.lO,m.uz,m.he,m.nf,m.To,m.Ki,m.ln,m.ai,z.l,u.QX],styles:[".toolbar[_ngcontent-%COMP%]{height:40px;margin-top:0;margin-bottom:-10px}.toolbar[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:0;margin-bottom:0}.datarow[_ngcontent-%COMP%]{font-size:.8rem}.R[_ngcontent-%COMP%]{color:red}.A[_ngcontent-%COMP%], .PP[_ngcontent-%COMP%]{color:orange}.P[_ngcontent-%COMP%]{color:green}ion-icon[_ngcontent-%COMP%]{color:#fff}"]})}}return s})()}];let H=(()=>{class s{static{this.\u0275fac=function(e){return new(e||s)}}static{this.\u0275mod=t.$C({type:s})}static{this.\u0275inj=t.G2t({imports:[v.iI.forChild(G),v.iI]})}}return s})();var V=c(9244);let X=(()=>{class s{static{this.\u0275fac=function(e){return new(e||s)}}static{this.\u0275mod=t.$C({type:s})}static{this.\u0275inj=t.G2t({imports:[u.MD,O.YN,m.bv,H,V.Q]})}}return s})()}}]);