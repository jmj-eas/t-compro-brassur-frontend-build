"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8676],{8676:(B,f,a)=>{a.r(f),a.d(f,{DetallecobranzaPageModule:()=>Q});var T=a(177),D=a(9417),s=a(7343),p=a(1050),u=a(467),g=a(7468),v=a(8765),F=a(8448),_=a(5312),t=a(4438),S=a(9777),L=a(7586),O=a(5689);let R=(()=>{class r{constructor(i,e){this.printSvc=i,this.currencyPipe=e,this.CMD=this.printSvc.data}buildTicket(i){let e=new F.L(0,2),o="DL"===i.moneda?"USD":"PYG",n="Ctz:"+Number(i.ctz).toFixed(2);e.write("Brassur S.A. "),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write("Comercial e Industrial"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write("Ruta Mcal. Jos\xe9 F. Estigarribia 1282"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write("Tel: (021) 501 029"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`RUC: 80002555-5 COMP:(${i.impresoId})`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`Rec: ${i.nroFisico} Mov: ${i.movId}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`Fecha: ${L(i.fecHoraMov).format("DD/MM/YYYY")} ${L().format("HH:mm")}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`Emit.Por: ${i.emitidoPor}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`${n}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_ON),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_CT),e.write("**  PROVEEDOR  **"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_OFF),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_LT),e.write(`RUC: ${i.personaId}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(`${i.personaNom}`),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_CT),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_ON),e.write("**  RECIBOS  **"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_OFF),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_LT),e.write("Nro.                    Importe"),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF);let c="";for(const l of i.detalles)c="DL"===l.idmoneda?"DL":"PYG",e.write(this.printSvc.alignData(l.nrodoc,17,"left")),e.write(this.printSvc.alignData(l.idmoneda,4,"left")),e.write(this.printSvc.alignData(this.currencyPipe.transform(l.mto,c,""),3,"right")),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF);const d=this.printSvc.alignData("TOT. REC.: "+i.moneda+" "+this.currencyPipe.transform(i.totalDocumentos,o,""),10,"right");e.write(d),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_CT),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_ON),e.write("**  VALORES  **"),e.write(this.CMD.TEXT_FORMAT.TXT_BOLD_OFF),e.write(this.CMD.TEXT_FORMAT.TXT_ALIGN_LT),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF);let h="";for(const l of i.valores)if(h="DL"===l.idmoneda?"USD":"PYG",l.mtototal){let E=this.printSvc.alignData(l.siglas+(l.nrodoc?`(${l.nrodoc})`:""),17,"left");e.write(E),e.write(this.printSvc.alignData(l.idmoneda,4,"left")),E=this.printSvc.alignData(this.currencyPipe.transform(l.mtototal,h,""),3,"right"),e.write(E),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF)}const C=this.printSvc.alignData("TOT. VAL.: GS "+this.currencyPipe.transform(i.totalValores,"PYG",""),10,"right");return e.write(C),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(i.tipoTicket),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e.write(this.CMD.FEED_CONTROL_SEQUENCES.CTL_LF),e}static{this.\u0275fac=function(e){return new(e||r)(t.KVO(O.H),t.KVO(T.oe))}}static{this.\u0275prov=t.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var b=a(5161),M=a(2464),N=a(1527),w=a(2130),P=a(385);function I(r,m){1&r&&(t.j41(0,"p",11),t.EFF(1,"Impresora no conectada"),t.k0s())}function U(r,m){if(1&r&&(t.j41(0,"ion-row")(1,"ion-col",17),t.EFF(2),t.k0s(),t.j41(3,"ion-col",2),t.EFF(4),t.k0s(),t.j41(5,"ion-col",18),t.EFF(6),t.nI1(7,"number"),t.k0s()()),2&r){const i=m.$implicit;t.R7$(2),t.JRh(i.desvalor),t.R7$(2),t.JRh(i.idmoneda),t.R7$(2),t.JRh(t.bMT(7,3,i.mtototal))}}function A(r,m){if(1&r&&(t.j41(0,"ion-list")(1,"ion-grid")(2,"ion-row")(3,"ion-col",17),t.EFF(4,"Tipo"),t.k0s(),t.j41(5,"ion-col",2),t.EFF(6,"Moneda"),t.k0s(),t.j41(7,"ion-col",18),t.EFF(8,"Monto"),t.k0s()(),t.DNE(9,U,8,5,"ion-row",19),t.k0s()()),2&r){const i=t.XpG(2);t.R7$(9),t.Y8G("ngForOf",i.valores)}}function X(r,m){if(1&r&&(t.j41(0,"ion-row")(1,"ion-col",17),t.EFF(2),t.k0s(),t.j41(3,"ion-col",17),t.EFF(4),t.k0s(),t.j41(5,"ion-col",17),t.EFF(6),t.k0s(),t.j41(7,"ion-col",18),t.EFF(8),t.nI1(9,"number"),t.k0s()()),2&r){const i=m.$implicit;t.R7$(2),t.JRh(i.tipopago),t.R7$(2),t.JRh(i.iddoc),t.R7$(2),t.JRh(i.iddocsec),t.R7$(2),t.Lme("",t.bMT(9,5,i.mto)," ",i.idmoneda,"")}}function j(r,m){if(1&r&&(t.j41(0,"ion-list")(1,"ion-grid")(2,"ion-row")(3,"ion-col",17),t.EFF(4,"Tipo"),t.k0s(),t.j41(5,"ion-col",17),t.EFF(6,"Factura"),t.k0s(),t.j41(7,"ion-col",17),t.EFF(8,"Cuota"),t.k0s(),t.j41(9,"ion-col",18),t.EFF(10,"Monto"),t.k0s()(),t.DNE(11,X,10,7,"ion-row",19),t.k0s()()),2&r){const i=t.XpG(2);t.R7$(11),t.Y8G("ngForOf",i.facturas)}}function z(r,m){if(1&r){const i=t.RV6();t.j41(0,"ion-grid")(1,"ion-row",12)(2,"ion-col",13)(3,"ion-segment",14),t.mxI("ngModelChange",function(o){t.eBV(i);const n=t.XpG();return t.DH7(n.currentSegment,o)||(n.currentSegment=o),t.Njj(o)}),t.j41(4,"ion-segment-button",15)(5,"ion-label"),t.EFF(6,"Facturas"),t.k0s()(),t.j41(7,"ion-segment-button",16)(8,"ion-label"),t.EFF(9,"Formas Pago"),t.k0s()()(),t.DNE(10,A,10,1,"ion-list",8)(11,j,12,1,"ion-list",8),t.k0s()()()}if(2&r){const i=t.XpG();t.R7$(3),t.R50("ngModel",i.currentSegment),t.R7$(7),t.Y8G("ngIf","resumen"===i.currentSegment),t.R7$(),t.Y8G("ngIf","cobro"===i.currentSegment)}}const y=[{path:"",component:(()=>{class r{constructor(i,e,o,n,c,d,h,C,l,E,V,x){this.printSvc=i,this.ticketService=e,this.route=o,this.router=n,this.currencyPipe=c,this.loaderSvc=d,this.authSvc=h,this.alertCtrl=C,this.alertSvc=l,this.apiSvc=E,this.toastController=V,this.modalCtrl=x,this.facturas=[],this.valores=[],this.totalAmount=0,this.totalAmountVal=0,this.maskType="separator.0",this.currentSegment="cobro",this.bluetoothList=[],this.selectedPrinter=null,this.ticket=new F.L(0,2),this.imprimirCopia=!1,this.moneda="",this.VALOR_VUELTO_ID="26",this.VALOR_EFECTIVO_ID="1",this.route.queryParams.subscribe(J=>{this.router.getCurrentNavigation().extras.state&&(this.cobroRecibido=this.router.getCurrentNavigation().extras.state,this.data=this.cobroRecibido.data,this.cliente=this.cobroRecibido.cliente,this.cobrador=this.cobroRecibido.cobrador,this.moneda=this.data.idmoneda)})}ngOnInit(){var i=this;return(0,u.A)(function*(){i.getPrinters(),yield i.loaderSvc.show("Cargando"),(0,g.p)([i.apiSvc.post("/resumentipovalormovto",{entidad:16,idmov:i.data.idmov}),i.apiSvc.post("/listacobrodetalle",{entidad:16,idmov:i.data.idmov})]).subscribe({next:e=>{i.valores=e[0].data,i.facturas=e[1].data,i.loaderSvc.stop(),i.totalAmount=i.facturas.reduce((o,n)=>o+Number(n.mto),0),i.totalAmountVal=i.valores.reduce((o,n)=>o+(n.idtipovalor!==i.VALOR_VUELTO_ID?parseInt(n.mtototal)||0:-1*parseInt(n.mtototal)||0),0),i.cobroData={identidad:16,idmov:i.data.idmov,idusuario:i.authSvc.getUserInfo()?.usuario,idcaja:i.data.idcaja,idcobrador:i.cobrador.id,idcliente:i.cliente.id,nomcliente:i.cliente.nombre,nroidentcliente:i.cliente.documento,fechoramov:i.data.fechoramov,ctz:i.data.ctz,genrecibo:"S",nrofisico:i.data.nrofisico,detalles:i.facturas.map(o=>({iddocprin:o.iddoc,iddocsec:o.iddocsec,mto:o.mto,mtomora:0,tipopago:o.tipopago,idmoneda:o.idmoneda,nrodoc:o.nrofisico2})),valores:i.valores.filter(o=>o.mtototal).map(o=>{let n=o.idtipovalor===i.VALOR_VUELTO_ID?o.mtototal:0;return n?n*=-1:n=o.mtototal,{idtipovalor:o.idtipovalor,mto:n,idmoneda:o.idmoneda,idbanco:null,nrovalor:o.nrodoc,fecvalor:null,cantcuota:null,siglas:o.siglas,mtototal:o.mtototal}})}},error:e=>{i.alertSvc.error("Error al obtener detalle de cobranza"),i.loaderSvc.stop()}})})()}getPrinters(){this.printSvc.searchBluetoothPrinter().then(i=>{this.bluetoothList=i,this.selectedPrinter=this.bluetoothList.length>0?this.bluetoothList.filter(e=>_.c.impresora.includes(e.name))[0]:null})}submit(){var i=this;return(0,u.A)(function*(){i.selectedPrinter?"S"===i.cobroData.genrecibo&&i.copiaConfirm():i.presentToast("Debe seleccionar una impresora")})()}copiaConfirm(){var i=this;return(0,u.A)(function*(){(yield i.alertCtrl.create({header:"Confirmaci\xf3n",message:"Tipo de Impresion",buttons:[{text:"Original",handler:()=>{i.loaderSvc.show("Imprimiendo original..").then(()=>{i.buildTicket(i.cobroData,"N"),i.print(),i.loaderSvc.stop()})}},{text:"Copia",handler:()=>{i.loaderSvc.show("Imprimiendo copia..").then(()=>{i.buildTicket(i.cobroData,"S"),i.print(),i.loaderSvc.stop()})}}]})).present()})()}buildTicket(i,e){this.ticketData={movId:i.idmov,fecHoraMov:i.fechoramov,nroFisico:i.nrofisico,personaId:this.cliente.documento,personaNom:this.cliente.nombre,moneda:this.moneda,ctz:i.ctz,impresoId:this.cobrador.id,emitidoPor:"",totalDocumentos:this.totalAmount,totalValores:this.totalAmountVal,detalles:this.cobroData.detalles,valores:this.cobroData.valores,tipoTicket:"S"===e?"Copia":"Original"},this.ticket=this.ticketService.buildTicket(this.ticketData)}print(){var i=this;return(0,u.A)(function*(){if(i.selectedPrinter)try{let n,e=i.ticket.buffer.length,o=i.ticket.buffer.reverse().findIndex(l=>0!==l);-1!==o&&(n=e-o),i.ticket.buffer.reverse();let c=2*n,d=1024;d=c<1024?1024:c>=1024&&c<2048?2048:4096;let C=new F.L(d,2);C.write(i.ticket.buffer.subarray(0,n)),yield i.printSvc.sendToBluetoothPrinter(i.selectedPrinter.id,C.buffer),i.ticket.trim().flush(),i.ticket.clear()}catch(e){i.ticket.trim().flush(),i.ticket.clear(),i.alertSvc.error(e)}else i.presentToast("Debe seleccionar una impresora")})()}selectPrinter(){var i=this;return(0,u.A)(function*(){const e=yield i.modalCtrl.create({component:v.i,componentProps:{impresoras:i.bluetoothList,selectedPrinter:i.selectedPrinter}});yield e.present();const{data:o}=yield e.onDidDismiss();o&&(i.selectedPrinter=o.impresora)})()}presentToast(i){var e=this;return(0,u.A)(function*(){(yield e.toastController.create({message:i,duration:2e3})).present()})()}static{this.\u0275fac=function(e){return new(e||r)(t.rXU(S.B),t.rXU(R),t.rXU(p.nX),t.rXU(p.Ix),t.rXU(T.oe),t.rXU(b.Z),t.rXU(M.u),t.rXU(s.hG),t.rXU(N.u),t.rXU(w.G),t.rXU(s.K_),t.rXU(s.W3))}}static{this.\u0275cmp=t.VBU({type:r,selectors:[["app-detallecobranza"]],decls:15,vars:6,consts:[["title","Detalle Cobranza"],["color","primary",1,"ion-text-center","header-title"],[1,"ion-text-center"],[1,"ion-color-dark"],["class","print-warning",4,"ngIf"],["right",""],[3,"click"],["name","print","slot","icon-only"],[4,"ngIf"],[1,"animated","fadeIn","fast"],["expand","full","color","medium","size","large",1,"ion-no-padding","ion-no-margin",3,"click"],[1,"print-warning"],[1,"ion-justify-content-center"],["size-md","6","size","12"],[3,"ngModelChange","ngModel"],["value","cobro"],["value","resumen"],[1,"ion-text-start"],[1,"ion-text-end"],[4,"ngFor","ngForOf"]],template:function(e,o){1&e&&(t.j41(0,"app-header",0)(1,"ion-toolbar",1)(2,"p",2)(3,"ion-text",3),t.EFF(4),t.nI1(5,"number"),t.k0s()(),t.DNE(6,I,2,0,"p",4),t.k0s(),t.j41(7,"div",5)(8,"ion-button",6),t.bIt("click",function(){return o.selectPrinter()}),t.nrm(9,"ion-icon",7),t.k0s()()(),t.j41(10,"ion-content"),t.DNE(11,z,12,3,"ion-grid",8),t.k0s(),t.j41(12,"ion-footer",9)(13,"ion-button",10),t.bIt("click",function(){return o.submit()}),t.EFF(14,"Imprimir "),t.k0s()()),2&e&&(t.R7$(4),t.Lme("Total Facturas ",o.moneda,": ",t.bMT(5,4,o.totalAmount),""),t.R7$(2),t.Y8G("ngIf",!o.selectedPrinter),t.R7$(5),t.Y8G("ngIf",o.valores.length>0))},dependencies:[T.Sq,T.bT,D.BC,D.vS,s.Jm,s.hU,s.W9,s.M0,s.lO,s.iq,s.he,s.nf,s.ln,s.Gp,s.eP,s.IO,s.ai,s.Je,P.l,T.QX],styles:["ion-col[_ngcontent-%COMP%]{font-size:12px}"]})}}return r})()}];let k=(()=>{class r{static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275mod=t.$C({type:r})}static{this.\u0275inj=t.G2t({imports:[p.iI.forChild(y),p.iI]})}}return r})();var G=a(9244),$=a(5188);let Q=(()=>{class r{static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275mod=t.$C({type:r})}static{this.\u0275inj=t.G2t({imports:[T.MD,D.YN,s.bv,k,G.Q,$.mB]})}}return r})()}}]);